# 📜 Step 6: Rules の作成

## 目標

- Cursor の Rules（ルール）の仕組みを理解する
- プロジェクト固有のルールを作成する
- TDD を強制するルールを設定する

---

## 6.1 Rules とは？

**Rules（ルール）** は、Cursor のエージェントに対して継続的な指針を与える仕組みです。
プロジェクトルートの `.cursor/rules/` ディレクトリに `.mdc` ファイルとして配置します。

### ルールの種類

| 種類 | 説明 | 設定方法 |
|-----|------|---------|
| Always | 常に適用 | `alwaysApply: true` |
| Auto Attached | 特定ファイルに自動適用 | `globs: ["*.ts"]` |
| Agent Requested | エージェントが必要時に参照 | `description` を記載 |
| Manual | 手動で参照 | `@ruleName` で指定 |

---

## 6.2 ルールファイルの構造

```markdown
---
description: ルールの説明（Agent Requested で使用）
globs: ["対象ファイルパターン"]
alwaysApply: false
---

# ルールのタイトル

ルールの内容をここに記述します。
```

---

## 6.3 実践: TDD ルールを作成する

### ルールファイルの作成

`.cursor/rules/tdd-handson.mdc` を作成します：

```markdown
---
description: TDD ハンズオン用のルール。テスト駆動開発を強制する。
globs: ["handson/**/*.ts"]
alwaysApply: false
---

# TDD ハンズオン開発ルール

## 基本原則

handson/ ディレクトリ内のコードを編集する際は、
必ず **TDD（テスト駆動開発）** のサイクルに従ってください。

## 開発フロー

1. **🔴 Red** - まずテストを書く
   - 実装より先にテストを作成
   - テストが失敗することを確認

2. **🟢 Green** - テストを通す最小限の実装
   - テストが通る最小限のコードを書く
   - 過度な最適化は後回し

3. **🔵 Refactor** - リファクタリング
   - テストが通ったままコードを改善
   - 重複の排除、可読性の向上

## コーディング規約

- 関数には必ず JSDoc コメントを付ける
- イミュータブルな実装を心がける
- エラーハンドリングを適切に行う

## テストの書き方

- describe でグループ化
- it で個別のテストケースを記述
- 日本語でテストケース名を記述
- expect で期待値を明確に

## 禁止事項

- テストなしでの実装追加
- any 型の使用
- console.log のコミット
```

### エージェントに依頼してルールを作成

```
以下の内容で TDD 用のルールファイルを作成してください：
- ファイルパス: .cursor/rules/tdd-handson.mdc
- 対象: handson/ ディレクトリ
- 内容: TDD のサイクルを強制するルール

ルールには以下を含めてください：
- Red → Green → Refactor の説明
- コーディング規約
- 禁止事項
```

---

## 6.4 実践: コードスタイルルールを作成する

### ルールファイルの作成

`.cursor/rules/code-style-handson.mdc` を作成します：

```markdown
---
description: ハンズオン用コードスタイルルール
globs: ["handson/**/*.ts"]
alwaysApply: false
---

# コードスタイルルール

## 命名規則

- 変数名: camelCase（例: `todoList`, `isCompleted`）
- 関数名: camelCase（例: `addTodo`, `toggleTodo`）
- 型名: PascalCase（例: `Todo`, `TodoFilter`）
- 定数: UPPER_SNAKE_CASE（例: `DEFAULT_FILTER`）

## 関数の書き方

- 純粋関数を優先する
- 副作用は最小限に
- 1つの関数は1つの責務

## エクスポート

- 名前付きエクスポートを使用
- default エクスポートは避ける

## コメント

- JSDoc 形式でドキュメント化
- Why を説明するコメント
- What は明らかなら省略可
```

---

## 6.5 ルールの適用を確認する

### 方法1: 自動適用の確認

`globs` に一致するファイルを編集すると、ルールが自動適用されます。

```
handson/challenge/src/logic/todo.ts に新しい関数を追加してください。
```

エージェントが TDD ルールに従って、
まずテストを書いてから実装を書くはずです。

### 方法2: 手動で参照

```
@tdd-handson ルールに従って、
新しい関数 clearCompleted を実装してください。
```

---

## 6.6 ルールのデバッグ

### ルールが適用されているか確認

```
現在適用されているルールを教えてください。
```

### ルールが期待通り動かない場合

1. **ファイルパスの確認** - `globs` パターンが正しいか
2. **構文エラーの確認** - YAML フロントマターが正しいか
3. **内容の明確さ** - 曖昧な表現がないか

---

## 6.7 Tips: 効果的なルールの書き方

### ✅ 良いルール

```markdown
# 関数の命名規則

関数名は動詞で始める:
- ✅ addTodo, deleteTodo, toggleTodo
- ❌ todo, todoAdd, TodoDelete
```

### ❌ 悪いルール

```markdown
# 命名規則

適切な名前を付けてください。
```

### ポイント

1. **具体的に** - 例を示す
2. **簡潔に** - 500行以内を目安
3. **焦点を絞る** - 1つのルールに1つの目的
4. **明確に** - 曖昧な表現を避ける

---

## 6.8 演習: 独自ルールを作成する

以下のルールを作成してみましょう：

### 演習1: エラーハンドリングルール

```
.cursor/rules/error-handling-handson.mdc を作成してください。

内容:
- エラー時の処理方法
- カスタムエラークラスの使い方
- エラーメッセージの書き方
```

### 演習2: テスト命名ルール

```
.cursor/rules/test-naming-handson.mdc を作成してください。

内容:
- describe/it の命名規則
- テストケースのグループ化方法
- 日本語でのテスト記述ルール
```

---

## チェックリスト

以下が完了していることを確認してください：

- [ ] Rules の仕組みを理解した
- [ ] TDD ルール（tdd-handson.mdc）を作成した
- [ ] コードスタイルルール（code-style-handson.mdc）を作成した
- [ ] ルールが適用されることを確認した
- [ ] 独自ルールを作成できた

---

## 次のステップ

👉 [07_commands.md](./07_commands.md) に進んで、カスタムコマンドを作成しましょう！
