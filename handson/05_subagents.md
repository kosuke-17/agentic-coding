# 🔀 Step 5: Subagents の活用

## 目標

- Subagent（サブエージェント）の概念を理解する
- 複雑なタスクを分担させる方法を学ぶ
- 実際にサブエージェントを使った作業分離を体験する

---

## 5.1 Subagent とは？

**Subagent（サブエージェント）** は、親エージェントから別タスクを委譲される小さい AI ワーカーです。

### メリット

1. **コンテキストの分離** - 異なるタスクを独立して処理
2. **並列処理** - 複数のタスクを同時進行
3. **専門性** - 特定のタスクに集中できる

### 使いどころ

- 長い調査・分析タスク
- 独立した機能の実装
- テスト失敗の原因調査
- コードレビュー・改善提案

---

## 5.2 Subagent の使い方

Cursor のエージェントモードでは、エージェントが必要に応じてサブエージェントを生成します。
明示的にサブエージェントを活用するには、タスクを明確に分割して依頼します。

### 基本的な依頼パターン

```
以下の2つのタスクを並行して進めてください：

タスク1: handson/src/todo.ts のコードレビューを行い、改善点をリストアップ
タスク2: handson/test/todo.test.ts に不足しているエッジケースのテストを追加
```

---

## 5.3 実践: テスト失敗の原因調査

### シナリオ

テストが失敗しているが、原因がわからない場合を想定します。

### 演習: 意図的にバグを入れる

まず、`handson/src/todo.ts` の `toggleTodo` 関数に意図的なバグを入れてみましょう：

```typescript
// バグ: completed の反転が正しくない
export function toggleTodo(todos: Todo[], id: string): Todo[] {
  const todoExists = todos.some(todo => todo.id === id);
  if (!todoExists) {
    throw new Error(`Todo with id "${id}" not found`);
  }
  
  return todos.map(todo => {
    if (todo.id === id) {
      return { ...todo, completed: true }; // バグ: 常に true になる
    }
    return todo;
  });
}
```

### 演習: サブエージェントに調査を依頼

```
テストを実行すると toggleTodo のテストが失敗します。
以下のタスクを分担して調査してください：

タスク1（調査）:
- 失敗しているテストケースの特定
- エラーメッセージの分析
- 期待値と実際の値の比較

タスク2（原因特定）:
- handson/src/todo.ts の toggleTodo 関数のコードレビュー
- バグの原因箇所の特定
- 修正案の提示

調査結果をまとめて報告してください。
```

### 期待される結果

エージェントが以下のような分析を行います：

1. テスト実行結果の確認
2. 失敗しているテストの特定
3. コードの問題箇所の発見
4. 修正案の提示

---

## 5.4 実践: コードレビューと改善

### シナリオ

実装は動いているが、コードの品質を向上させたい場合。

### 演習: 複数観点でのレビュー

```
handson/src/todo.ts のコードを以下の観点でレビューしてください。
それぞれ独立したタスクとして扱ってください：

観点1（パフォーマンス）:
- 不要なループはないか
- データ構造は適切か
- 計算量は妥当か

観点2（可読性）:
- 変数名は明確か
- 関数の責務は単一か
- コメントは適切か

観点3（保守性）:
- 重複したコードはないか
- テストしやすい設計か
- 将来の拡張に対応しやすいか

各観点での改善提案をまとめてください。
```

---

## 5.5 実践: 新機能の設計と実装の分離

### シナリオ

新機能を追加する際に、設計と実装を分離して進める。

### 演習: TODO の編集機能を追加

```
TODO の編集機能（updateTodo）を追加します。
以下のタスクを分担して進めてください：

タスク1（設計）:
- 関数シグネチャの設計
- テストケースの洗い出し
- エッジケースの検討

タスク2（テスト作成）:
- タスク1の設計に基づいてテストを作成
- handson/test/todo.test.ts に追加

タスク3（実装）:
- テストが通る実装を作成
- handson/src/todo.ts に追加

各タスクの成果物を順番に作成してください。
```

---

## 5.6 Tips: サブエージェントを効果的に使う

### 適切なタスク分割

```
❌ 悪い例: タスクが曖昧
「TODO アプリを改善して」

✅ 良い例: タスクが明確
「以下の3つのタスクを実行：
  1. パフォーマンス分析
  2. テストカバレッジ確認
  3. ドキュメント生成」
```

### 依存関係の明示

```
✅ 良い例: 依存関係を明示
「タスク1の結果に基づいてタスク2を実行してください」
```

### 結果の統合を依頼

```
✅ 良い例: 統合を依頼
「各タスクの結果をまとめて、優先度順に並べてください」
```

---

## 5.7 サブエージェント活用のユースケース

| ユースケース | 説明 |
|-------------|------|
| バグ調査 | テスト失敗の原因を多角的に調査 |
| コードレビュー | 複数の観点で並行レビュー |
| リファクタリング | 分析と実装を分離 |
| ドキュメント生成 | コードと仕様書を同時作成 |
| テスト拡充 | 既存テストの分析と新規テスト作成 |

---

## チェックリスト

以下が完了していることを確認してください：

- [ ] サブエージェントの概念を理解した
- [ ] テスト失敗の調査をサブエージェントに依頼できた
- [ ] 複数観点でのコードレビューを依頼できた
- [ ] タスク分割して作業を進められた

---

## 次のステップ

👉 [06_rules.md](./06_rules.md) に進んで、ルールを使ったエージェントの制御を学びましょう！
